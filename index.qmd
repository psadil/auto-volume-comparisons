---
title: Comparing Automated Subcortical Volume Estimation Methods; Amygdala Volumes Estimated by FSL and FreeSurfer have Low Consistency.
author:
  - name: Patrick Sadil
    corresponding: true
    email: psadil1@jh.edu
    affiliations:
      - ref: jhu
  - name: Martin A. Lindquist
    corresponding: false
    affiliations:
      - ref: jhu
affiliations:
  - id: jhu
    name: Johns Hopkins Bloomberg School of Public Health
keywords:
  - MRI
  - Amygdala
abstract: |
  Subcortical volumes are a promising source of biomarkers and features in biosignatures, and automated methods facilitate extracting them in large, phenotypically rich datasets. However, while extensive research has verified that the automated methods produce volumes that are similar to those generated by expert annotation, the consistency of methods with each other is understudied. Using data from the UK Biobank, we compare the estimates of subcortical volumes produced by two popular software suites: FSL and FreeSurfer. Although most subcortical volumes exhibit good to excellent consistency across the methods, the tools produce diverging estimates of amygdalar volume. Through simulation, we show that this poor consistency can lead to conflicting results, where one but not the other tool suggests statistical significance, or where both tools suggest a significant relationship but in opposite directions. Considering these issues, we discuss several ways in which care should be taken when reporting on relationships involving amygdalar volume. 
plain-language-summary: |
  . ...
key-points:
  - Two popular methods of automated subcortical segmentation, FreeSurfer and FIRST, produce estimates of volume with variable consistency.
date: last-modified
bibliography: references.bib
number-sections: true
notebook-links: false
crossref:
  custom:
    - kind: float
      key: sfig
      latex-env: sfig
      reference-prefix: Figure A
      space-before-numbering: false
      latex-list-of-description: Supplementary Figure
      caption-prefix: Figure A
    - kind: float
      key: stbl
      latex-env: stbl
      reference-prefix: Table A
      space-before-numbering: false
      latex-list-of-description: Supplementary Table
      caption-prefix: Table A
knitr:
  opts_chunk: 
    dev: tikz
---

```{r setup}
library(patchwork)
library(dplyr)
library(ggplot2)
library(agree)
library(tidyr)
library(purrr)

source(here::here("R/figures.R"))
targets::tar_load(ukb_vols_long)
targets::tar_load(ukb_vols) 

n_for_sim <- targets::tar_read(amyg_vols) |>
  dplyr::distinct(f.eid) |>
  dplyr::n_distinct()

tbl_iccs <- ukb_vols_long |>
  filter(stringr::str_detect(Method, "FSSUBSEG", negate=TRUE)) |>
  pivot_wider(names_from = Method, values_from = Volume) |>
  group_nest(Hemisphere, Structure) |>
  mutate(
    icc = map(
      data,
      ~select(.x, FIRST, FreeSurfer) |>
        irr::icc(model="twoway")),
    lower = map_dbl(icc, pluck, "lbound"),
    upper = map_dbl(icc, pluck, "ubound"),
    icc = map_dbl(icc, pluck, "value"),
    iccA = map(
      data,
      ~select(.x, FIRST, FreeSurfer) |>
        irr::icc(model="twoway",type = "agreement")),
    lowerA = map_dbl(iccA, pluck, "lbound"),
    upperA = map_dbl(iccA, pluck, "ubound"),
    iccA = map_dbl(iccA, pluck, "value"),
    across(c(icc, lower, upper), \(x) round(x, 2) |> format(nsmall=2)),
    across(c(iccA, lowerA, upperA), \(x) round(x, 2) |> format(nsmall=2))
  ) |>
  select(-data)

```

# Introduction

Regional volumes of subcortex have been proposed as biomarkers for several psychopathologies. For example, the volume of the amygdala has been suggested as a biomarker for Alzheimer's, depression symptom severity in young adults, bipolar disorder in youth, migraine frequency, chronic pain, and others [@daftary_relationship_2019; @khatri_alzheimers_2022; @pfeifer_meta-analysis_2008; @liu_hippocampus_2017; @vachon-presseau_corticolimbic_2016; @rogers_smaller_2009; @ruocco_amygdala_2012; @szeszko_amygdala_2004]. As a biomarker, subcortical volumes are advantageous for being interpretable (given the rich literature linking these structures to many functions), explainable (hypotrophy and hypertrophy are both easily described to healthcare providers and patients), and readily available. The latter point comes from the fact that it is possible to estimate the regional volumes from any structural image with several automated algorithms.

For estimating regional subcortical volumes, two automated techniques are popular: FMRIB's Integrated Registration and Segmentation Tool (FIRST) from the FMRIB Software Library (FSL) and FreeSurfer's Automated Segmentation (ASEG) [@patenaude2007; @patenaude2011; @fischl2012]. Both techniques exhibit high consistency with the gold-standard of manual segmentation in healthy adults and some clinical populations [@hsu2002; @tae2008; @morey2009; @pardoe2009; @dewey2010; @lehmann2010; @doring2011; @nugent_automated_2013; @wenger_comparing_2014], although there is variability across regions and between methods. For segmenting the hippocampus, FreeSurfer has been reported as having higher intraclass correlations than FSL [@doring2011], and neither method appears to have worse reliability (across repeated scans) than manual segmentation [@mulder_hippocampal_2014]. For the putamen, FSL has a higher Dice coefficient with manual segmentation, and the methods perform similarly on the caudate [@perlaki2017]. For the amygdala, which method performs better depends on the metric [@morey2009]. However, these comparisons may not generalize to other populations (e.g., pediatric, elderly), given that performance of the automated techniques is not consistently high across populations [@schoemaker2016; @kim2012; @s√°nchez-benavides2010; @zhou_charting_2021].

While comparisons to manual segmentation could identify which method produces the best estimates of volume, it remains less clear how the two methods compare to each other. To our knowledge, the two methods have only been compared to each other by @perlaki2017. In their research, the methods were consistent with each other (exhibiting intraclass correlations that ranged from around 0.7 - 0.9), but the analyses included only the putamen and caudate, and the sample size was relatively small (N=30). We extend the results of @perlaki2017 to the remaining structures and with a much larger population (tens of thousands). Our investigation should be considered in the context of research that would use estimates of volume as a biomarker by, for example, correlating volume with a health-related outcome. Our primary concern is whether the results of such a study could be expected to depend on the method used for automated segmentation.

# Methods and Results

First, we looked at the consistency of subcortical volumes between FSL and FreeSurfer using data from the UK Biobank [@alfaro-almagro_image_2018]. The data were downloaded Jan 2024 and contained `r dplyr::n_distinct(ukb_vols$f.eid)` participants with usable anatomical data (Category 190: FreeSurfer ASEG; Category 1102: FSL FIRST). For details on intraclass correlation calculations, see [-@sec-icc-models]. Estimates and associated uncertainty are displayed using subscripts, as recommended by @louis_effective_2008. For example, an estimate of 0.22 with a 95% confidence interval spanning [0.21, 0.23] will be rendered as $_{0.21}0.22_{0.23}$.

::: {#fig-vol-comparison}

```{r}
#| fig-height: 7

targets::tar_load(fig_vol_comparison)
fig_vol_comparison

```

Comparisons of Subcortical Volumes Estimated by FSL and FreeSurfer for two example regions a) Hippocampus and b) Amygdala. For remaining subcortical regions, see @stbl-iccs. In the lower triangular panels, the line of equivalence is marked with a solid line, and the dashed lines show the result of orthogonal regression. In the upper panel, the uncertainty estimates span 95% confidence intervals. The histograms along the diagonal display volumes in the full sample. 

:::

Across all structures, estimated agreement was lower than estimated consistency (@stbl-iccs), reflecting differences in the average volumes estimated by the two methods ([-@sec-avg-shift]). However, a constant shift across participants would not affect our primary focus, which is related to estimated correlations between regional volumes and some other measure. For that reason, we focus not on agreement but instead on consistency.

```{r contrasts}

fit_amygdala <- lme4::lmer(
  Volume ~ Method*Hemisphere + (1 | f.eid), 
  filter(ukb_vols_long, Structure == "Amygdala") |> 
    mutate(f.eid = factor(f.eid)))

fit_amygdala_contrasts <- fit_amygdala |>
  emmeans::emmeans(pairwise ~ Hemisphere*Method) 

fit_amygdala_contrasts_interaction <- fit_amygdala_contrasts |>
  emmeans::contrast(interaction="pairwise") |>
  broom::tidy() |>
  mutate(estimate = round(estimate, 2) |> format(nsmall=2))

fit_amygdala_contrasts_disp <- fit_amygdala_contrasts |>
  pluck("contrasts") |>
  broom::tidy() |>
  mutate(estimate = round(estimate, 2) |> format(nsmall=2)) 
  

```

```{r, tbl_iccs_prep}

tbl_iccs_amg <- tbl_iccs |>
  filter(Structure=="Amygdala") |>
  select(Hemisphere, Structure, icc, lower, upper) |>
  pivot_wider(names_from = Hemisphere, values_from = c(icc, lower, upper))

tbl_iccs_hip <- tbl_iccs |>
  filter(Structure=="Hippocampus") |>
  select(Hemisphere, Structure, icc, lower, upper) |>
  pivot_wider(names_from = Hemisphere, values_from = c(icc, lower, upper))

```


Consistency varies by region (@fig-vol-comparison, @stbl-iccs). To interpret the intraclass correlations, consider the categories provided by @cicchetti1981: <0.4: poor, [0.4, 0.6): fair, [0.6, 0.75): good, [0.75, 1): excellent. Using those categories, the methods exhibit "good" to "excellent" consistency for most regions. However, the consistency of volumes for the amygdala is markedly worse than the others, being around only ~`r tbl_iccs_amg$lower_Left`~`r tbl_iccs_amg$icc_Left`~`r tbl_iccs_amg$upper_Left`~ and ~`r tbl_iccs_amg$lower_Right`~`r tbl_iccs_amg$icc_Right`~`r tbl_iccs_amg$upper_Right`~ for the left and right hemispheres (ranges of uncertainty span 95% confidence intervals). Compare the amygdala to the hippocampus (@fig-vol-comparison), which has good consistency (left: ~`r tbl_iccs_hip$lower_Left`~`r tbl_iccs_hip$icc_Left`~`r tbl_iccs_hip$upper_Left`~, right: ~`r tbl_iccs_hip$lower_Right`~`r tbl_iccs_hip$icc_Right`~`r tbl_iccs_hip$upper_Right`~). For both structures (that is, the amygdala and hippocampus), consistency across hemispheres as reported by FreeSurfer is the highest numerically (@fig-vol-comparison). For the amygdala, there is a two-way interaction between method and hemisphere (FSL - FreeSurfer: `r fit_amygdala_contrasts_interaction$estimate`, $p<0.001$), with FreeSurfer reporting that the right amygdala is larger than the left (left - right: `r fit_amygdala_contrasts_disp[fit_amygdala_contrasts_disp$contrast=="Left FreeSurfer - Right FreeSurfer",]$estimate`, $p<0.001$) and FSL reporting that the left is larger than the right (left - right: `r fit_amygdala_contrasts_disp[fit_amygdala_contrasts_disp$contrast=="Left FIRST - Right FIRST",]$estimate`, $p<0.001$).

The amygdala has been described as particularly challenging to segment; one small study (N=23) reports a consistency of 0.6 for volumes estimated by FSL across repeated scans of the same individual [@morey2010]. Moreover, automated segmentation algorithms can be affected by experimental factors like site, scanner, participant positioning, and software version [@hedges2022; @du2021; @mcguire2017; @yang2016; @liu2020; @mulder_hippocampal_2014; @morey2010; @perlaki2017], and differential sensitivity to such factors could impact an intraclass correlation. In the UKB, several potentially confounding factors were correlated with estimates of amygdalar volume (@sfig-partials-amyg). However, regressing these factors from the estimates of volume did not improve the consistency between the methods ([-@sec-confounds]).

With poor consistency between measurements of the amygdala, there is concern that reported relationships involving amygdala volumes may depend on which method is used for estimating the volume, a choice that may be considered arbitrary or lab-specific. At least two kinds of issues could arise. First, lower consistency could make it more likely that one but not both methods leads to significant correlations. Second, lower consistency could make it more likely that the two methods produce significant correlations that go in opposite directions. 

::: {#fig-sm-errors}

```{r}
#| fig-width: 8
#| fig-height: 6

targets::tar_load(c(icc_data2, cog_dif_sig, cog_dif_dir))

ukb_examples <- left_join(
  cog_dif_sig |>
    select(predictor, N, ds_med, ds_lower, ds_upper, Hemisphere),
  cog_dif_dir |>
    mutate(estimate = abs(estimate)),
  by = join_by(predictor, N, Hemisphere)) |>
  filter(stringr::str_detect(Hemisphere, "Left")) |>
  na.omit()

a <- icc_data2 |>
  filter(N < 200) |>
  mutate(across(c(icc, rho), factor)) |>
  pivot_longer(
    c(starts_with("dd"), starts_with("ds")), 
    names_to = c("type", "level"), 
    names_sep = "_",
    values_to = "value") |>
  mutate(
    type = case_match(
      type, 
      "dd" ~ "Different\nDirection",
      "ds" ~ "Different\nSignificance"),
    Effect = factor(type, levels = c("Different\nSignificance", "Different\nDirection"))) |>
  pivot_wider(names_from = level) |>
  rename(ICC=icc) |>
  ggplot(aes(x=N, y=rho, fill=med)) +
  facet_grid(ICC~Effect, labeller = label_both) +
  geom_raster() +
  scale_fill_viridis_c(
    option="turbo",
    name="Estimated\nProportion",
    limits = c(0, 1)) +
  scale_x_continuous(
    "N Participants",
    breaks = c(0, 50, 100),
    labels = c(0, 50, 100)) +
  ggtitle("Artificial Data") +
  theme_gray(base_size = 9)


b <- ukb_examples |>
  pivot_longer(
    c(starts_with("dd"), starts_with("ds")), 
    names_to = c("Effect", "level"), 
    names_sep = "_",
    values_to = "value") |>
  filter(level=="med") |>
  mutate(
    Effect = case_match(
      Effect, 
      "dd" ~ "Different\nDirection",
      "ds" ~ "Different\nSignificance"),
    Effect = factor(Effect, levels = c("Different\nSignificance", "Different\nDirection")),
    predictor = stringr::str_sub(predictor, 3),
    rho = glue::glue("({format(estimate, nsmall = 2, digits=1)})"),
    Variable = interaction(predictor, rho, sep = " ", lex.order=FALSE)) |>
  ggplot(aes(x=N, y=Variable, fill=value)) +
  facet_wrap(~Effect, labeller = label_both, ncol=2) +
  geom_raster() +
  scale_fill_viridis_c(
    option="turbo",
    name = "Estimated\nProportion",
    limits = c(0, 1)) +
  ylab("Cognitive Variable (rho)") +
  scale_x_continuous(
    "N Participants",
    breaks = c(0, 50, 100),
    labels = c(0, 50, 100)) +
  ggtitle("UKB")  +
  theme_gray(base_size = 9)

a + b + plot_layout(ncol=2, guides = "collect") + plot_annotation(tag_levels = "a", tag_suffix = ")") & theme(legend.position = "bottom")
```


Effects of Low Measurement Consistency. In the subfigures, the left column or panel shows the proportion of simulated experiments where the methods produce correlations on opposite sides of an $\alpha=0.05$ significance threshold. The right column or panel shows the proportion of simulated experiments where both measures are significantly correlated with an outcome but in opposite directions. Proportions are shown with color [@swihart_lasagna_2010]. a) Simulations with Artificial Data. Rows (rho) indicate pre-specified correlation. ICC: assumed intraclass correlation between measures of volume. b) Simulations with UKB. Each row corresponds to a non-image derived phenotype from the UKB. The value in parentheses is the absolute correlation of the variable with the average volumes of the left amygdala (average across methods). For a display without color that includes estimates of uncertainty, see @sfig-left-right.
:::

To investigate how often these two issues could occur, we first simulated experiments with artificial data. In each simulation, datasets with two noisy estimates of volume and a third, outcome, variable were generated such that the two volume estimates had a pre-specified intraclass correlation with each other (in expectation), and the true volume had a given product-moment correlation with the outcome variable. The estimated volumes were then tested for a product-moment correlation with the outcome, and the process was repeated for several intraclass correlations and sample sizes. In all simulations, the true product-moment correlation was set to a value that is either typical for neuroimaging research [0.1, @marek_reproducible_2022], small but non-zero (0.01), or large (0.2). For additional details on the simulation methods, see [-@sec-sim-details].

```{r art_example}
art_example_50 <- icc_data2 |> 
  filter(icc == 0.2, N==50, rho==0.1) |>
  mutate(across(starts_with(c("ds_", "dd_")), \(x) format(x*100, digits = 3, nsmall=1)))
art_example_100 <- icc_data2 |> 
  filter(icc == 0.2, N==100, rho==0.1) |>
  mutate(across(starts_with(c("ds_", "dd_")), \(x) format(x*100, digits = 3, nsmall=1)))

ukb_example_min <- ukb_examples |>
  filter(N==50) |>
  slice_min(order_by = ds_med, n=1) |>
  mutate(across(starts_with(c("ds_", "dd_")), \(x) format(x*100, digits = 3, nsmall=1)))

ukb_example_max <- ukb_examples |>
  filter(N==50) |>
  slice_max(order_by = ds_med, n=1) |>
  mutate(across(starts_with(c("ds_", "dd_")), \(x) format(x*100, digits = 3, nsmall=1)))
```


With lower consistency, the estimated product-moment correlations were more often on opposite sides of a significance threshold (@fig-sm-errors$\~$a, left column). For example, with consistency near the value that was estimated for volumes of the amygdala in the UKB (0.2), a typical effect size (0.1), and experiments with 50 participants, significance differed in around ~`r art_example_50$ds_lower`~`r art_example_50$ds_med`~`r art_example_50$ds_upper`~ percent of simulations in which one test was significant (for simulations, estimates indicate medians and ranges of uncertainty span 95% equal-tailed intervals, see [-@sec-sim-details]). With a sample size of 100, that percentage was only minimally different (to ~`r art_example_100$ds_lower`~`r art_example_100$ds_med`%~`r art_example_100$ds_upper`~). For a discussion on this insensitivity to sample size, see @sec-min.

Lower consistency also coincided with a higher proportion of experiments in which the two methods correlate in opposite directions (@fig-sm-errors$\~$a, right column). Considering the previous example (an intraclass correlation of 0.2, an effect size of 0.1, and 50 participants per experiment), around ~`r art_example_50$dd_lower`~`r art_example_50$dd_med`~`r art_example_50$dd_upper`~ percent of experiments in which both product-moment correlations were significant resulted in the correlations having opposite signs. As the intraclass correlation increased, the rates of this effect decreased rapidly.

To assess how often these two issues could occur in practice, we repeated the above analyses but with the UKB. From the UKB, we extracted the "Cognitive" variables using the FMRIB UKBiobank Normalisation, Parsing And Cleaning Kit [@mccarthy_funpack_2023], restricting analyses to variables with instance 2 and that exhibited one of the largest (in absolute magnitude) 50 rank correlations (between the cognitive variables and the average of the two estimates of the volume of the left amygdala), and further to only those participants that had values for all 50 of those variables (`r n_for_sim` participants). Each simulation resulted in a rank correlation between the two volume estimates for the left amygdala and each of the 50 variables (results were comparable with the right amygdala). For additional details, see [-@sec-sim-details].

Considering differing significance levels, the rates across experiments using the UKB resembled the rates from experiments with artificial data. In simulated experiments with 50 UKB participants in which at least one correlation was significant, one correlation was not significant in between ~`r ukb_example_min$ds_lower`~`r ukb_example_min$ds_med`~`r ukb_example_min$ds_upper`~ and ~`r ukb_example_max$ds_lower`~`r ukb_example_max$ds_med`~`r ukb_example_max$ds_upper`~ percent of simulations (the two estimates cover the 50 cognitive variables; @fig-sm-errors$\~$b, left panel). Proportions were generally lower for variables that were more strongly correlated with the measure of volume (for illustration, compare the variables that are higher versus lower in the left panel of @fig-sm-errors$\~$b).

Considering significant correlations with differing signs, the rates across experiments with the UKB bracketed the rates with artificial data. In experiments simulated with 50 UKB participants, the rates ranged from ~`r ukb_example_min$dd_lower`~`r ukb_example_min$dd_med`~`r ukb_example_min$dd_upper`~ to ~`r ukb_example_max$dd_lower`~`r ukb_example_max$dd_med`~`r ukb_example_max$dd_upper`~. For most variables, increasing the number of participants decreased the proportion of experiments in which the two correlations exhibited opposite signs, but for some the proportion increased. Across the 50 variables, 9 had a higher proportion at N=100 than N=50, 2 of which had non-overlapping 95% equal-tailed intervals (6348: duration to complete numeric path; 400: time to complete round of pairs matching game; see also @sfig-left-right).

# Discussion

We examined the consistency of subcortical volumes within the UK Biobank [@alfaro-almagro_image_2018], observing that two common methods of estimating the volume of the amygdala, one from FSL and one from FreeSurfer, have poor consistency with each other. The main concern in this report is that consistency this poor can lead to conflicting results. Two kinds of conflict were explored: the methods producing correlations that are on opposite sides of significance thresholds, and the methods producing volumes with significant correlations that have differing signs. The prevalence of these occurrences was estimated with artificial data and data from the UKB. Based on the observed rates, we make the following recommendations.

## Recommendations

### When testing for new biomarkers, report relationships with multiple automated methods (e.g., both FSL and FreeSurfer).

Researchers may have idiosyncratic reasons for selecting a method, particularly when the choice is viewed as arbitrary. If the choice between methods is arbitrary, then reporting the outcome across selections clarifies the fragility or robustness of a result [for a general discussion, see @steegen_increasing_2016]. The choice may not always be arbitrary, as there are metrics along which and study populations for which one method may perform better [@zhou_charting_2021; @morey2009; @huizinga_differences_2021]. Note that one effect of low consistency could be a downward bias on the magnitude of estimated correlations (@sec-measurement-error), and so there may be advantages to not only reporting but also combining the estimates across methods when predicting health-related outcomes (e.g., by averaging, or including both as independent variables in predictive models). Reporting estimates from multiple reasonable tools will help move conclusions beyond "there exists a correlation with the volume of the amygdala as estimated by method M (version x)" to simply "there exists a correlation with the volume of the amygdala".

### When reviewing or conducting meta-analyses of relationships with amygdala volume, consider the method that was used to estimate volume.

As mentioned in the Introduction, the amygdala has received substantial attention due to being predictive of an array of health-related outcomes. As presented in this report, the volume that is estimated by one automated method may only weakly correspond to the volume estimated by another, and so it may be misleading to conduct a meta-analysis without accounting for the algorithms used by the individual studies. In the UKB, there are differences in the strength of the correlations between the measures of volume and the cognitive variables; in nearly all of the variables considered in this report, the magnitude of the correlations involving FreeSurfer's method were numerically larger (@sfig-pop-cor). Larger correlations do not imply higher veracity, but they further indicate that the methods track aspects of amygdalar anatomy differently.

### When replicating or extending research on a relationship that involves the volume of the amygdala, use the method reported in the original publications.

This recommendation follows standard practice for a replication study. We highlight it here in consideration of both extension studies that aim to apply a biomarker or biosignature that includes amygdala volume (such as when testing a putative relationship in a new population), and also in consideration of the ongoing evolution of methods for automatically estimating subcortical volumes. Although FSL and FreeSurfer are two of the most popular methods, others exist [e.g., @akhondi-asl2013], including newer techniques based on deep-learning approaches [e.g., @billot2023; for review, see @singh2021]. Newer methods may have better correspondence with manual segmentation, warranting their use in replication or extension studies. But as this report shows, two methods can perform well while exhibiting poor consistency with each other. So when building on prior findings, it remains important to use the methods of those prior findings, even when they are superseded. 

# References {.unnumbered}

::: {#refs}
:::

\newpage
\appendix

# Supplementary Materials {#sec-supplements}

## Intraclass Correlation {#sec-icc-models}

The intraclass correlation was based on a two-way mixed linear model [@mcgraw1996]. In the model, the volume $x$ for the region of participant $i$ as measured by method $k$ was treated as equal to the sum of an intercept, $\nu$, the "true" volume, $\lambda_i$, a method bias, $c_k$, and an error term, $\epsilon_{ik}$

$$
\begin{aligned}
x_{ik} &= \nu + \lambda_i + c_k + \epsilon_{ik} \\
\sum_k c_k &= 0 \\
\lambda_i &\sim N(0,\sigma_\lambda^2) \\
\epsilon_{ik} &\sim N(0, \sigma_\epsilon^2)
\end{aligned}
$$

Note that the $c_k$ terms are assumed fixed, with variance given by $\sigma_c^2=\sum_k c_k^2/(k-1)$.

An important assumption of this model is that the two methods are expected to have the same mean-squared error. The model does not include features that would allow for the errors in the two methods to be correlated (e.g., participants are not distinguished by characteristics that coincide with the methods performing better or worse).

The consistency version of the intraclass correlation, $ICC(C,1)$, and the absolute agreement, $ICC(A,1)$ were given as fractions of the variance components

$$
\begin{aligned}
ICC(C,1) & = \frac{\sigma_\lambda^2}{\sigma_\lambda^2 + \sigma_\epsilon^2} \\
ICC(A,1) & = \frac{\sigma_\lambda^2}{\sigma_\lambda^2 + \sigma_\epsilon^2 + \sigma_c^2}
\end{aligned}
$$

Variance components and associated confidence intervals estimated using the `R` package `irr` [@core_r_2023; @gamer_irr_2019], which uses the mean square approach described by @mcgraw1996.

## Differences in Average Volumes {#sec-avg-shift}

Although we primarily focused on the consistency of the methods, we also observed shifts in the average volumes reported by the two methods (@sfig-biases-perc). Differences in averages across methods have been reported previously [@gomez-ramirez2022; @perlaki2017; @dewey2010; @huizinga_differences_2021]. FSL tends to report volumes that are larger than those from FreeSurfer for the Accumbens, Amygdala, Hippocampus, and Pallidum, whereas for the Caudate, Putamen, and Thalamus FSL tends to report values that are smaller than those from FreeSurfer (all $p < 0.0001$ for two-sided t-test). Across structures, the variability in the difference appears to covary with the average of the two volume estimates, increasing as the average volume estimate decreases (@sfig-biases-perc b). 

::: {#sfig-biases-perc}

```{r sfig-biases-perc}
#| fig-height: 7

targets::tar_load(fig_biases_perc)
fig_biases_perc
```

Bland-Altman Plots for Subcortical Volume. Horizontal lines show average difference and limits of agreement (1.96 standard deviations), with ribbons marking 95% confidence intervals. Panels correspond to subcortical structures. Left and right structures are plotted together. Shifts in the average estimate correspond to the central ribbon excluding zero. The color overlay indicates the degree of overplotting. a) Raw Differences. Note that axes are across panels independently. b) Differences by Percent Average.

:::


\FloatBarrier

## Intraclass Correlations Across All Subcortical Regions {#sec-other-structs}

::: {#stbl-iccs}

```{r stbl-iccs}

tbl_iccs |> 
  mutate(
    icc = glue::glue("@@{lower}@{icc}@@{upper}@"),
    iccA = glue::glue("@@{lowerA}@{iccA}@@{upperA}@"),
  ) |>
  select(Structure, Hemisphere, `ICC(C,1)`=icc, `ICC(A,1)`=iccA) |>
  arrange(Structure) |>
  gt::gt() |> 
  gt::text_transform(
    fn = subscript_formatting, 
    locations = gt::cells_body(columns=c("ICC(C,1)", "ICC(A,1)"))
  ) |>
  gt::as_latex()
```

Intraclass Correlation for Subcortical Structures. Subscripts indicate 95% confidence intervals.

:::

\FloatBarrier

## Intraclass Correlations After Residualizing on Potential Confounds {#sec-confounds}

One possible source of low intraclass correlations could be systematic inaccuracies with certain kinds of participants. For example, one of the two methods could tend to underestimate volumes when given brains that have experienced severe atrophy, which would decrease the agreement of the methods. To assess this, correlations between the amygdala volumes and the "simple" confounds within the UKB were calculated [@alfaro-almagro2021].

Several of the correlations appeared to be non-zero (@sfig-partials-amyg). However, regressing these confounds from the estimated amygdala volumes did not improve the intraclass correlations (@stbl-iccs-deconfounded).

::: {#sfig-partials-amyg}

```{r sfig-partials-amyg}
#| fig-height: 7

# NOTE: this says "partials", but they are full correlations

targets::tar_load(partials)

partials |>
  dplyr::select(
    Variable=Parameter1, 
    Summary=Parameter2, 
    lower=CI_low, 
    upper=CI_high, 
    Hemisphere) |>
  mutate(
    Variable = forcats::fct_relabel(
      Variable, stringr::str_remove, "site"),
    Variable = forcats::fct_relabel(
      Variable, stringr::str_remove, "sex"),
    Variable = forcats::fct_relabel(
      Variable, stringr::str_replace, "_a", ":A"),
    Variable = forcats::fct_relabel(
      Variable, stringr::str_replace, "_t", ":T"),
    Variable = forcats::fct_relabel(
      Variable, stringr::str_replace, "_h", ":H"),
    Variable = forcats::fct_relabel(
      Variable, stringr::str_replace, "_M", ":M"),
    Variable = forcats::fct_relabel(
      Variable, stringr::str_replace, "_d", " D"),
    Variable = forcats::fct_relabel(
      Variable, stringr::str_replace, "_s", " S"),
    Variable = forcats::fct_relabel(
      Variable, stringr::str_replace, "_m", " M"),
    Variable = forcats::fct_relabel(
      Variable, stringr::str_replace, "2", "$^2$"),
    Summary = case_match(
      Summary,
      ".difference" ~ "Difference",
      ".average" ~ "Average"
    )) |>
  ggplot(aes(y=Variable, color=Summary)) + 
  geom_errorbarh(aes(xmin=lower, xmax=upper)) + 
  facet_wrap(~Hemisphere, labeller = label_both) +
  xlab("Product-Moment Correlation with Summarized Amygdala Volumes") +
  theme_gray(base_size = 9) +
  theme(legend.position = "bottom") 

```

Correlation Between Potential Confounders and Amygdala Volume Measurements. Summary describes how the the volumes were combined across methods. Summaries were either an average or a difference (FSL-FreeSurfer). Note that the variable "Head Size" corresponds to a scaling factor, and that larger values imply smaller brains.

:::

::: {#stbl-iccs-deconfounded}

```{r stbl-iccs-deconfounded}

ukb_vols |>
  mutate(acq_day = (acq_day - min(acq_day)) |> as.numeric()) |>
  na.omit() |>
  mutate(
    age2 = age^2,
    acq_day2 = acq_day^2,
    across(
      c(age, age2, t1_motion, head_size, acq_day, acq_day2), 
      \(x) (x - median(x)) / mad(x)),
    .by = site) |>
  pivot_longer(
    c(contains("Left"), contains("Right")),
    names_to = c("Structure", "Method"),
    names_pattern = "([[:print:]]+)_(FIRST|FreeSurfer)",
    values_to = "Volume") |>
  mutate(
    m = mean(Volume),
    Volume = resid(lm(Volume ~ site + (age*sex):site + age2:site + t1_motion:site + head_size:site + acq_day:site + acq_day2:site)),
    Volume = Volume + m,
    .by = c(Structure, Method)) |>
  select(-m) |>
  pivot_wider(names_from = Method, values_from = Volume) |>
  separate(Structure, c("Hemisphere", "Structure")) |>
  group_nest(Hemisphere, Structure) |>
  mutate(
    icc = map(
      data,
      ~select(.x, FIRST, FreeSurfer) |>
        irr::icc(model="twoway")),
    lower = map_dbl(icc, pluck, "lbound"),
    upper = map_dbl(icc, pluck, "ubound"),
    icc = map_dbl(icc, pluck, "value"),
    across(c(icc, lower, upper), \(x) round(x, digits=2) |> format(nsmall=2)),
    icc = glue::glue("@@{lower}@{icc}@@{upper}@"),
    iccA = map(
      data,
      ~select(.x, FIRST, FreeSurfer) |>
        irr::icc(model="twoway",type = "agreement")),
    lower = map_dbl(iccA, pluck, "lbound"),
    upper = map_dbl(iccA, pluck, "ubound"),
    iccA = map_dbl(iccA, pluck, "value"),
    across(c(iccA, lower, upper), \(x) round(x, digits=2) |> format(nsmall=2)),
    iccA = glue::glue("@@{lower}@{iccA}@@{upper}@"),
  ) |>
  select(Structure, Hemisphere, `ICC(C,1)`=icc, `ICC(A,1)`=iccA) |>
  arrange(Structure) |>
  gt::gt() |> 
  gt::text_transform(
    fn = subscript_formatting, 
    locations = gt::cells_body(columns=c("ICC(C,1)", "ICC(A,1)"))
  ) |>
  gt::as_latex()

```

Intraclass Correlation After Deconfounding. Prior to calculating consistency, volumes were deconfounded by a version of the "simple" parameter set described by @alfaro-almagro2021. For the list of variables, see @sfig-partials-amyg. Subscripts indicate 95% confidence intervals.

:::

\FloatBarrier

### Adjusting for ICV {#sec-adjust-icv}

When reporting differences in volume between groups, it is common to adjust for either head size or cerebral volume [@barnes_head_2010; @mathalon_correction_1993; @voevodskaya_effects_2014]. Adjusting by intracranial volume as estimated by FreeSurfer did not improve the intraclass correlations (@stbl-adjust).

::: {#stbl-adjust}


```{r stbl-adjust}
#| fig-pos: 't'

ukb_vols_long |>
  filter(stringr::str_detect(Method, "FSSUBSEG", negate=TRUE)) |>
  pivot_wider(names_from = Method, values_from = Volume) |>
  mutate(
    across(
      c(ends_with("FreeSurfer"), ends_with("FIRST")), 
      \(x) mean(x) + resid(lm(x ~ icv)))) |>
  group_nest(Hemisphere, Structure) |>
  mutate(
    icc = map(
      data,
      ~select(.x, FIRST, FreeSurfer) |>
        irr::icc(model="twoway")),
    lower = map_dbl(icc, pluck, "lbound"),
    upper = map_dbl(icc, pluck, "ubound"),
    icc = map_dbl(icc, pluck, "value"),
    across(c(icc, lower, upper), \(x) round(x, 2) |> format(nsmall=2)),
    icc = glue::glue("@@{lower}@{icc}@@{upper}@"),
    iccA = map(
      data,
      ~select(.x, FIRST, FreeSurfer) |>
        irr::icc(model="twoway",type = "agreement")),
    lower = map_dbl(iccA, pluck, "lbound"),
    upper = map_dbl(iccA, pluck, "ubound"),
    iccA = map_dbl(iccA, pluck, "value"),
    across(c(iccA, lower, upper), \(x) round(x, 2) |> format(nsmall=2)),
    iccA = glue::glue("@@{lower}@{iccA}@@{upper}@"),
  ) |>
  select(Structure, Hemisphere, `ICC(C,1)`=icc, `ICC(A,1)`=iccA) |>
  arrange(Structure) |>
  gt::gt() |> 
  gt::text_transform(
    fn = subscript_formatting, 
    locations = gt::cells_body(columns=c("ICC(C,1)", "ICC(A,1)"))
  ) |>
  gt::as_latex()

```

Consistency of Volumes when Adjusting by Intracranial Volume. Adjustments were done by residualizing with respect to ICV. Subscripts indicate 95% confidence intervals.

:::

\FloatBarrier

## Simulated Experiments {#sec-sim-details}

To simulate hypothetical data, the models described in the previous sections were used. Sample sizes were set between 10 to 100 in steps of 10. At each combination of parameters, experiments were repeated 1,000,000 times. Simulated experiments with the UKB data were performed analogously to those with hypothetical data (UKB samples were taken with replacement). 

```{r sigma_lambda}
sigma_lambda <- targets::tar_read(sigma_lambda) |>
  round(3) |>
  format(nsmall=3)
```


In all simulations with artificial data, several parameters described in @sec-icc-models would not influence results after setting an intraclass and interclass correlation and so were set to arbitrary values: $\nu=0$, $\sigma_\delta=1$, and $\sigma_c=0$. The remaining parameter $\sigma_\lambda$ was set to a value that was estimated from the full UKB with a linear mixed-effects model that was estimated by restricted maximum likelihood as implemented by `lme4` [@bates_fitting_2015]: `r sigma_lambda`.

Across repetitions, the rates of each effect were estimated by analytic Bayesian methods (binomial likelihood with Beta prior whose shape parameters were set to 1/2). For the effect of "Different Significance", the posterior was based on the number of simulations in which one correlation exhibited a $p$-value less than 0.05 and the other was above 0.05 (successes among relevant simulations) and the number of simulations in which at least one $p$-value was below 0.05 (total relevant simulations). The effect of "Different Direction" was calculated similarly, but used simulations in which both correlations had opposite magnitudes out of those in which both were significant. In the main text, ranges of uncertainty refer to 95% equal-tailed intervals and proportions refer to posterior medians.

The 95% equal-tailed interval of the posteriors for the simulations are shown in @sfig-left-right.

::: {#sfig-left-right}

```{r sfig-left-right}
#| fig-height: 11
#| fig-width: 8

a <- make_spaghetti(
  select(cog_dif_sig, -ends_with("avg")), 
  select(cog_dif_dir, -ends_with("avg")), 
  "Left") +
  ylab("Estimated Proportion")
b <- make_spaghetti(
  select(cog_dif_sig, -ends_with("avg")), 
  select(cog_dif_dir, -ends_with("avg")), 
  "Right") +
  ylab("Estimated Proportion")

a + b + 
  plot_layout(guides = "collect", ncol = 1) + 
  plot_annotation(tag_levels = "a", tag_suffix = ")") &
  theme(legend.position = "bottom")

```

Effects of Low Measurement Consistency on the UKB in Left and Right Hemispheres. Ribbons span 95% equal-tailed interval estimated from simulated experiments. See also @fig-sm-errors, where the medians are represented with color.

:::

\FloatBarrier

## Differing Significance Minimally Affected by Increasing Sample Sizes When ICC is Low {#sec-min}

As described in the main text, when intraclass correlations were low, increasing the sample size affected the rates of differing significance only minimally [@fig-sm-errors]. This lack of influence can be understood by inspecting the distribution of simulated correlations [@sfig-why-flat]. When the intraclass correlation is low [left column of @sfig-why-flat], the significance of one correlation is nearly uninformative about the significance of the other (that is, the distributions of the two correlations are nearly circular). Moreover, the power to detect small correlations with even 100 participants is low, and so the power for two tests is very low. But when the intraclass correlation is higher [right column of @sfig-why-flat], the two correlations cluster, which improves the power of a second test conditioning on one test being significant.

::: {#sfig-why-flat}

```{r}
#| fig-height: 4
#| fig-width: 4
#| cache.lazy: false

targets::tar_load(why_flat)
why_flat
```

Correlations from Simulations with Artificial Data. Points correspond to simulations and are colored based on statistical significance. The figure shows only a subset of the simulated sample sizes (rows), only the smallest and largest intraclass correlations (columns), and only simulations in which the true effect size (correlation) was 0.1. 

:::


\FloatBarrier



## Measurement Error and Reduced Correlation Magnitude {#sec-measurement-error}

Using the model from [-@sec-icc-models], we can build a measurement noise model [e.g., @frost_correcting_2000]. Call the final target for which we hope to find a relationship with the volume $y$. The relationship between that value and the volume was given by an ordinary linear regression with error $\delta$.

$$
\begin{aligned}
y_i & = \beta_0 + \beta_1\lambda_i + \delta_i \\
\delta_i & \sim N(0, \sigma_\delta^2) \\
\end{aligned}
$$

But since we do not know $\lambda$, the volumes estimated by the tools are used instead, changing the regression coefficient as follows

$$
y_i = \beta_0 + \tilde{\beta_1}x_i + \delta_i \\
$$

Dilution occurs because the coefficient $\tilde{\beta_1}$ estimated in this model tends to be closer to zero, decreased by a factor related to the intraclass correlation [@frost_correcting_2000].

$$
\tilde{\beta_1} = \beta_1\frac{\sigma_\lambda^2}{\sigma_\lambda^2 + \sigma_\epsilon^2}
$$

Correspondingly, the desired correlation, $\rho=cor(y,\lambda)$, will also be biased.

$$
\begin{aligned}
\beta_1 & = \rho\frac{\sigma_\delta}{\sigma_\lambda} \\
\tilde{\beta_1} & = \tilde{\rho}\frac{\sigma_\delta}{sd(x)} \\ 
& =  \tilde{\rho} \frac{\sigma_\delta}{\sqrt{\sigma_\epsilon^2 + \sigma_\lambda^2}} \\
&  \implies \\
\rho \frac{\sigma_\delta}{\sigma_\lambda} &  = \tilde{\rho}\frac{\sigma_\delta}{\sqrt{\sigma_\epsilon^2+\sigma_\lambda^2}} \frac{\sigma_\lambda^2 + \sigma_\epsilon^2}{\sigma_\lambda^2} \\
&  \implies \\
\rho & = \tilde{\rho} \frac{\sqrt{\sigma_\epsilon^2+\sigma_\lambda^2}}{\sigma_\lambda }
\end{aligned}
$$

\FloatBarrier


## Correlations Between Volumes of the Amygdala and Cognitive Variables

As described in the main text, a set of 50 "cognitive" variables from the UKB was selected for each hemisphere. Selection was based on the rank correlation between the variable and the average (across methods) amygdalar volume. The correlations between those variables and the original volume estimates are shown in @sfig-pop-cor. For both hemispheres, the magnitude of the correlations with the volumes as reported by FreeSurfer tended to be higher than those reported by FSL.

::: {#sfig-pop-cor}

```{r sfig-pop-cor}
#| fig-height: 7

targets::tar_load(amyg_vols_cors)

amyg_vols_cors |> 
  summarise(
    lower=quantile(estimate, probs = 0.025), 
    upper=quantile(estimate, probs = 0.975), 
    .by = c(Method, predictor, Hemisphere)) |> 
  left_join(
    distinct(cog_dif_dir, rho=estimate, predictor, Hemisphere)) |> 
  mutate(
    predictor = interaction(predictor, round(abs(rho), digits=2)),
    predictor = ordered(predictor), 
    predictor = forcats::fct_relabel(predictor, ~stringr::str_extract(.x, "(?<=f.)([[:print:]]+)(?=.0.[[:digit:]]+$)")),
    Method = stringr::str_replace(Method, "FIRST", "FSL")) |> 
  ggplot(aes(y=predictor, color=Method)) + 
  facet_wrap(~Hemisphere, scales = "free_y", labeller = label_both) +
  geom_errorbarh(aes(xmin=lower, xmax=upper)) +
  ylab("Cognitive Variable") +
  xlab("Rank Correlation with Amygdala Volume") +
  theme_gray(base_size = 9) +
  theme(
    legend.position = "bottom"
  )

```

Correlations Between Cognitive Factors and Estimated Volumes of the Left and Right Amygdala. Variables are ordered by decreasing rank correlation using average of left hemisphere volume estimates. Note that variables were selected based on the magnitude of their correlation with amygdalar volumes, which differed across hemispheres, and so the variables in left and right panels differ. Error bars span 95% confidence intervals (bootstrapped with 1000 samples).

:::

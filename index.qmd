---
title: Comparing Automated Subcortical Volume Estimation Methods; Amygdala Volumes Estimated by FSL and FreeSurfer have Low Consistency.
author:
  - name: Patrick Sadil
    corresponding: true
    email: psadil1@jh.edu
    affiliations:
      - Johns Hopkins Bloomberg School of Public Health
  - name: [others TBD]
  - name: Martin Lindquist
    corresponding: false
    roles: []
    affiliations:
      - Johns Hopkins Bloomberg School of Public Health
keywords:
  - MRI
abstract: |
 . ...
plain-language-summary: |
  . ...
key-points:
  - Two popular methods of automated subcortical segmentation, FreeSurfer and FIRST, produce estimates of volume with variable consistency.
date: last-modified
bibliography: references.bib
number-sections: true
notebook-links: false
---

```{r setup}
library(patchwork)
library(dplyr)
library(ggplot2)
library(agree)
library(tidyr)
library(purrr)

source(here::here("R/figures.R"))
targets::tar_load(ukb_vols_long)
targets::tar_load(ukb_vols) 
n_for_sim <- targets::tar_read(amyg_vols) |>
  dplyr::distinct(f.eid) |>
  dplyr::n_distinct()

```

# Introduction

Regional volumes of subcortex have been proposed as biomarkers for several psychopathologies. For example, the volume of the amygdala could serve as a biomarker for Alzheimer's, depression symptom severity in young adults, bipolar disorder in youth, migraine frequency, and chronic pain [@daftary_relationship_2019; @khatri_alzheimers_2022; @pfeifer_meta-analysis_2008; @liu_hippocampus_2017; @vachon-presseau_corticolimbic_2016]. As a biomarker, subcortical volumes are advantageous for being interpretable (given that the structure is thought to play a role in many cognitive functions), explainable (hypotrophy or hypertrophy are both easily described to healthcare providers and patients), and readily available. The availability comes from being able to estimate the regional volumes from any structural image with several automated algorithms.

For estimating regional subcortical volumes, two automated techniques are popular: FMRIB's Integrated Registration and Segmentation Tool (FIRST) from the FMRIB Software Library (FSL) and FreeSurfer's Automated Segmentation (ASEG) [@patenaude2007; @patenaude2011; @fischl2012]. Both techniques exhibit high consistency with manual segmentation in healthy adults and some clinical populations [@hsu2002; @tae2008; @morey2009; @pardoe2009; @dewey2010; @lehmann2010; @doring2011], although there is variability across regions and between methods. For segmenting the hippocampus, FreeSurfer has been reported as having higher intraclass correlations than FSL [@doring2011], though neither method appears to have worse reliability (across repeated scans) than manual segmentation [@mulder_hippocampal_2014]. For the putamen, FSL may better match manual segmentation, and the methods perform similarly on the caudate [@perlaki2017]. For the amygdala, which method performs better depends on the metric [@morey2009]. These comparisons may not hold generalize to other populations (e.g., pediatric, elderly), given that performance of the automated techniques is not consistently high across populations [@schoemaker2016; @kim2012; @s√°nchez-benavides2010; @zhou_charting_2021].

While comparisons to manual segmentation could identify which methods produce the best estimates of volume for a given study, it remains less clear how the two methods compare to each other, and whether the there is consistency across the two methods. In particular, it remains unclear whether the consistency of the two methods can lead to situations where they produce different results. We were primarily concerned with research that would use estimates of volume as a biomarker by, for example, correlating volume with a health-related outcome.

# Methods and Results

First, we looked at the consistency of subcortical volumes between FSL and FreeSurfer using data from the UK Biobank [@alfaro-almagro_image_2018]. The data were downloaded Jan 2024 and contained `r dplyr::n_distinct(ukb_vols$f.eid)` participants with usable anatomical data (Category 190: FreeSurfer ASEG; Category 1102: FSL FIRST). For details on intraclass correlation calculations, see @sec-icc-models. Intervals (e.g., 95% confidence intervals, 95% equal-tailed intervals) are displayed in subscripts, as recommended by @louis_effective_2008.

```{r ukbv}
#| label: fig-vol-comparison
#| fig-cap: "Comparisons of Subcortical Volumes Estimated by FSL and FreeSurfer for two example regions a) Hippocampus and b) Amygdala. For remaining subcortical regions, see @tbl-iccs."
#| fig-height: 7

a <- ukb_vols |>
  plot_struct("Hippocampus", base_size = 8) |>
  GGally::ggmatrix_gtable() |>
  wrap_elements()
b <- ukb_vols |>
  plot_struct("Amygdala", base_size = 8) |>
  GGally::ggmatrix_gtable() |>
  wrap_elements()

a + b + 
  plot_layout(ncol = 1) + 
  plot_annotation(tag_levels = "a", tag_suffix = ")") & 
  theme(legend.position = "bottom")
```

Across all structures, estimated agreement was lower than estimated consistency, reflecting differences in the average volumes estimated by the two methods (@sec-avg-shift). However, a shift that is constant across participants would not affect our primary focus, which was related to estimated correlations between regional volumes and some other measure. For that reason, we focus not on agreement but instead on consistency.

The consistency varies by region, with, for example, the hippocampus exhibiting estimated intraclass correlations that are higher than those for the amygdala (@fig-vol-comparison). To interpret the intraclass correlations, consider the categories provided by @cicchetti1981: <0.4: poor, [0.4, 0.6): fair, [0.6, 0.75): good, [0.75, 1): excellent. Using those categories, most regions have "good" to "excellent" consistency across the methods (all intraclass correlations are shown in @tbl-iccs). However, the consistency for volumes of the amygdala are well below the threshold for "fair", around only $_{0.24}0.24_{0.25}$ and $_{0.21}0.22_{0.23}$ for the left and right hemispheres (ranges indicate 95% confidence intervals).

Estimated volumes can be affected by experimental factors like site, scanner, positioning, software version, and time [@hedges2022; @du2021; @mcguire2017; @yang2016; @liu2020; @mulder_hippocampal_2014; @morey2010]. The amygdala has been reported to be particularly challenging to segment, with one small study (N=23) reporting an intraclass correlation across repeated scans of the same individual for amygdala volumes estimated by FIRST of 0.6 [@morey2010]. Several confounding factors were correlated with estimates of amygdalar volume (@fig-partials-amyg). Consistency between the methods was not improved by regressing these factors from the estimates of volume (@sec-confounds, @tbl-iccs-deconfounded, @tbl-adjust).

With such low consistency for the amygdala, there is concern that a reported relationships involving amygdala volumes may depend on which method is used for estimating the volume, a choice that may be considered arbitrary. At least two kinds of issues could arise. First, lower consistency could make it more likely that one but not both methods leads to significant correlations. Second, lower consistency could make it more likely that the two methods produce significant correlations that go in opposite directions. 

```{r}
#| label: fig-sm-errors
#| fig-cap: "Effects of Low Measurement Consistency. The left panel show the proportion of simulated experiments where one method produces a non-significant correlation and the other produces a correlation whose p-value is between 0.025 and 0.05. The right panels show the proportion of simulated experiments where both measures are significantly correlated with an outcome but in opposite directions. Proportions are shown with color [@swihart_lasagna_2010]. a) Simulated Data. Rows (rho) indicate assumed true correlation. icc: assumed intraclass correlation between measures of volume. b) Simulated Experiments with UKB. Each row corresponds to a non-image derivated phenotype from the UKB. The value in parentheses is the absolute correlation of the variable with the average volumes of the left amygdala (average across methods)."
#| fig-width: 8
#| fig-height: 6

targets::tar_load(c(icc_data2))
targets::tar_load(cog_dif_sig)
targets::tar_load(cog_dif_dir)

a <- icc_data2 |>
  filter(icc < 0.5) |>
  mutate(across(c(icc, rho), factor)) |>
  pivot_longer(
    c(starts_with("dd"), starts_with("ds")), 
    names_to = c("type", "level"), 
    names_sep = "_",
    values_to = "value") |>
  mutate(
    type = case_match(
      type, 
      "dd" ~ "Different\nDirection",
      "ds" ~ "Different\nSignificance"),
    Effect = factor(type, levels = c("Different\nSignificance", "Different\nDirection"))) |>
  pivot_wider(names_from = level) |>
  rename(ICC=icc) |>
  ggplot(aes(x=N, y=rho, fill=med)) +
  facet_grid(ICC~Effect, labeller = label_both) +
  geom_raster() +
  scale_fill_viridis_c(
    option="turbo",
    name="Estimated\nProportion",
    limits = c(0, 0.5)) +
  scale_x_continuous(
    "N Participants",
    breaks = c(0, 50, 100),
    labels = c(0, 50, 100)) +
  ggtitle("Artificial Data") +
  theme_gray(base_size = 9)


b <- left_join(
  cog_dif_sig |>
    select(predictor, N, ds_med, Hemisphere),
  cog_dif_dir |>
    mutate(estimate = abs(estimate)),
  by = join_by(predictor, N, Hemisphere)) |>
  filter(stringr::str_detect(Hemisphere, "Left")) |>
  na.omit() |>
  pivot_longer(
    c(starts_with("dd"), starts_with("ds")), 
    names_to = c("Effect", "level"), 
    names_sep = "_",
    values_to = "value") |>
  mutate(
    Effect = case_match(
      Effect, 
      "dd" ~ "Different\nDirection",
      "ds" ~ "Different\nSignificance"),
    Effect = factor(Effect, levels = c("Different\nSignificance", "Different\nDirection")),
    predictor = stringr::str_sub(predictor, 3),
    rho = glue::glue("({round(estimate, digits = 2)})"),
    Variable = interaction(predictor, rho, sep = " ", lex.order=FALSE)) |>
  ggplot(aes(x=N, y=Variable, fill=value)) +
  facet_wrap(~Effect, labeller = label_both, ncol=2) +
  geom_raster() +
  scale_fill_viridis_c(
    option="turbo",
    name = "Estimated\nProportion",
    limits = c(0,0.5)) +
  ylab("Cognitive Variable (rho)") +
  scale_x_continuous(
    "N Participants",
    breaks = c(0, 50, 100),
    labels = c(0, 50, 100)) +
  ggtitle("UKB")  +
  theme_gray(base_size = 9)

a + b + plot_layout(ncol=2, guides = "collect") + plot_annotation(tag_levels = "a", tag_suffix = ")") & theme(legend.position = "bottom")
```

To estimate how often these issues occur, we first simulated experiments with artificial data. In each simulation, datasets with two estimates of volume and a third outcome variable were generated such that the two volume estimates had an expected intraclass correlation and the true volume had a given product-moment correlation with the outcome variable. The estimated volumes were then tested for a product-moment correlation with the outcome, and the process was repeated for several intraclass correlations and sample sizes. In all simulations, the true product-moment correlation was set to a value that is small but non-zero (0.01), typical for neuroimaging research [0.1, @marek_reproducible_2022], or large (0.2). For additional details, see @sec-sim-details.

With lower consistency, the estimated rank correlations were more often on opposite sides of a significance threshold (@fig-sm-errors a, left panel). For example, with consistency near the value that was estimated for the amygdala volumes (0.2) and a typical effect size (0.1), significance differed in around $_{32.2}32_{32.4}$ percent of simulations (for simulations, ranges indicate 95% equal-tailed intervals). That percentage was only marginally improved by increasing the sample size to 100 (to $_{31.7}31.9\%_{32.2}$).

Lower consistency also coincided with higher proportions of experiments in which the two methods correlate in opposite directions (@fig-sm-errors a, right panel). Considering the previous example (intraclass correlation of 0.2, effect size 0.1, and 50 participants per experiment), around $_{20.1}22\%_{23.3}$ of experiments in which both product-moment correlations were significant resulted in the correlations having opposite signs. As the intraclass correlation increased, the rates of this effect decreased rapidly, approaching 0% with an intraclass correlation of 0.4.

To assess how often these two issues could occur in practice, we repeated the above analyses but with data from the UKB (sampled with replacement). From the UKB, we extracted the "Cognitive" variables using the FMRIB UKBiobank Normalisation, Parsing And Cleaning Kit [@mccarthy_funpack_2023], restricting analyses to variables with instance 2 and that exhibited one of the largest (in absolute magnitude) 50 rank correlations (of the correlations between the cognitive variables and the average of the two estimates of the volume of the left amygdala), and further to only those participants that had values for all of 50 of those variables (`r n_for_sim` participants). Each simulation resulted in a rank correlation between the two volume estimates for the left amygdala and each of the 50 variables (results were comparable with the right amygdala).

Considering differing significance, the rates across experiments using the UKB matched the rates from experiments with artificial data. In simulated experiments with 50 UKB participants in which at least one correlation was significant, one correlation was not significant in between $_{25.5}25.6_{25.8}$ and $_{30.8}31.1_{31.3}$ percent of simulations (range across the 50 variables; @fig-sm-errors b, left panel). That percentage was generally lower for variables that were more strongly correlated with the measure of volume (compare the variables that are higher versus lower in the panel).

Considering significant correlations with differing signs, the rates across experiments with the UKB were generally lower than the rates with artificial data. In experiments simulated with 50 UKB participants, the rates ranged from $_{1.3}1.4\%_{1.6}$ to $_{10.1}10.7\%_{11.4}$. For most variables, increasing the number of participants decreased the proportion of experiments in which the two correlations exhibited opposite signs, but for some the proportion increased. Across the 50 variables, 9 had a higher proportion at N=100 than N=50, 2 of which had non-overlapping 95% equal-tailed intervals (6348: duration to complete numeric path; 400: time to complete round of pairs matching game; see also @fig-left-right). 

# Discussion

We explored the consistency of subcortical volumes within the UK Biobank [@alfaro-almagro_image_2018], observing that two common methods of estimating the volume of the amygdala, from FSL and FreeSurfer, have low consistency with each other. Simulations revealed that consistency this low could frustrate the interpretability of results in two ways: the two methods may commonly result in correlations that are on opposite sides of significance thresholds, and if they are both significant then they may be correlated in opposite directions. The frequency of these challenges were estimated with both artificial data and data from the UKB.

## Recommendations

### When testing for new biomarkers, report relationships with multiple automated methods (e.g., both FSL and FreeSurfer).

The main concerns in this report are that there are two methods for estimating amygdalar volume that are commonly used and yet have low consistency, and that low consistency alone can lead to conflicting results. Researchers may have idiosyncratic reasons for selecting a method, particularly when the choice is viewed as arbitrary. If the choice between methods is arbitrary, then reporting the outcome across selections clarifies the fragility or robustness of a result [for a general discussion, see @steegen_increasing_2016]. The choice may not always be arbitrary, as there are metrics and study populations for which one method may perform better [@zhou_charting_2021; @morey2009]. Note that one effect of low consistency could be a downward bias on the magnitude of estimated correlations (@sec-measurement-error), and so there may be advantages to not only reporting but combining the estimates across methods when predicting health-related outcomes (e.g., by averaging, or including both as independent variables in predictive models). Reporting estimates from multiple reasonable tools will help move conclusions beyond "there exists a correlation with the volume of the amygdala as estimated by method M (version x)" to simply "there exists a correlation with the volume of the amygdala".

### When reviewing or conducting meta-analyses of relationships with amygdala volume, consider the method that was used to estimate volume.

As mentioned in the Introduction, the amygdala has received substantial attention for being predictive of an array of health-related outcomes. As presented in this report, the volume that is reported by one automated method may only weakly correspond to the volume reported by another, and so it may be misleading to conduct a meta-analysis without accounting for the algorithms that were used by the individual studies. In the UKB, there are differences in the strength of the correlations between the measures of volume and the cognitive variables, with the magnitude of the correlations involving FreeSurfer's method being numerically larger in almost all of the variables considered in this report (@fig-pop-cor). Larger correlations do not imply higher veracity, but they further indicate that the methods track different aspects of amygdalar anatomy.

### When replicating or extending research on a relationship that involves the volume of the amygdala, use the method reported in the original publications.

This recommendation follows standard practice for a replication study, and we highlight it here in consideration of ongoing research into methods for automatically estimating subcortical volumes. Although FSL and FreeSurfer are two of the most popular methods for estimating subcortical volumes, other methods exist [e.g., @akhondi-asl2013], including newer techniques based on deep-learning approaches [e.g., @billot2023; for review, see @singh2021]. The newer methods may have better correspondence with manual segmentation, earning them consideration for replication or extension studies. But many machine learning models developed for neuroimaging have difficulty generalizing to new populations, or their generalizability remains understudied [@traut_insights_2022;@sui_neuroimaging-based_2020;@nielsen_machine_2020;@chen_sampling_2023;@woo_building_2017]. So when building on prior findings, it remains important to test the assess results when using the methods of those prior findings, even when they are older, or potentially superseded.

# Supplementary Materials {#sec-supplements}

## Intraclass Correlation {#sec-icc-models}

The intraclass correlation was based on a two-way mixed linear model [@mcgraw1996]. In the model, the volume $x$ for the region of participant $i$ as measured by method $k$ was treated as equal to the sum of an intercept, $\nu$, the "true" volume, $\lambda$, a method bias $c_k$, and an error term, $\epsilon$

$$
\begin{aligned}
x_{ik} &= \nu + \lambda_i + c_k + \epsilon_{ik} \\
\sum_k c_k &= 0 \\
\lambda_i &\sim N(0,\sigma_\lambda^2) \\
\epsilon_{ik} &\sim N(0, \sigma_\epsilon^2)
\end{aligned}
$$

Note that the $c_k$ terms are assumed fixed, and their variance is given by $\sigma_c^2=\sum_k c_k^2/(k-1)$.

An important assumption of this model is that the two methods are expected to have the same mean-squared error. The model does not include features that would allow for the errors in the two methods to be correlated (e.g., participants are not distinguished by characteristics that coincide with the methods performing better or worse).

The consistency version of the intraclass correlation, $ICC(C,1)$, and the absolute agreement, $ICC(A,1)$ were given as fractions of variance

$$
\begin{aligned}
ICC(C,1) & = \frac{\sigma_\lambda^2}{\sigma_\lambda^2 + \sigma_\epsilon^2} \\
ICC(A,1) & = \frac{\sigma_\lambda^2}{\sigma_\lambda^2 + \sigma_\epsilon^2 + \sigma_c^2}
\end{aligned}
$$


## Differences in Average Volumes {#sec-avg-shift}

Some of subcortical volumes were on average different when estimated by FSL and FreeSurfer (@fig-biases-perc), replicating previous findings [@gomez-ramirez2022].

```{r}
#| label: fig-biases-perc
#| fig-cap: "Bland-Altman Plots for Subcortical Volume. Horizontal lines show average difference and limits of agreement (1.96 standard deviations), with ribbons marking 95% confidence intervals. Panels correspond to subcortical structures. Volumes measured in cm$^3$. Left and right structures plotted together. Biases in the average are indicated by the central ribbon excluding zero. The differences (y-axis) are expressed as a percentage of the average difference."
#| fig-height: 6

ukb_vols_long |>
  pivot_wider(names_from = Method, values_from = Volume) |>
  mutate(
    .average = (FIRST + FreeSurfer) / 2,
    .difference = (FIRST - FreeSurfer) / .average * 100
  ) |>
  ggplot2::ggplot(ggplot2::aes(x = .average, y = .difference)) +
  facet_wrap(~Structure, scales = "free_x") +
  geom_ba() +
  scattermore::geom_scattermore(alpha=0.1, pointsize = 5) + 
  xlab("Average (FSL + FreeSurfer)/2") +
  ylab("Difference (FSL - FreeSurfer)/Average %") 
```


```{r}
#| label: fig-biases
#| fig-cap: "Bland-Altman Plots for Subcortical Volume. Horizontal lines show average difference and limits of agreement (1.96 standard deviations), with ribbons marking 95% confidence intervals. Panels correspond to subcortical structures. Volumes measured in cm^3. Left and right structures plotted together. Biases in the average are indicated by the central ribbon excluding zero."
#| fig-height: 6
#| eval: false

ukb_vols_long |>
  pivot_wider(names_from = Method, values_from = Volume) |>
  mutate(
    .difference = FIRST - FreeSurfer,
    .average = (FIRST + FreeSurfer) / 2
  ) |>
  ggplot2::ggplot(ggplot2::aes(x = .average, y = .difference)) +
  facet_wrap(~Structure, scales = "free") +
  geom_ba() +
  scattermore::geom_scattermore(alpha=0.3, pointsize = 5) + 
  xlab("Average ([FSL + FreeSurfer]/2)") +
  ylab("Difference (FSL - FreeSurfer)") 
```

\newpage 
## Intraclass Correlations Across All Subcortical Regions {#sec-other-structs}

```{r}
#| label: tbl-iccs
#| tbl-cap: "Intraclass Correlation for Subcortical Structures. Subscripts indicate 95% confidence intervals."

ukb_vols_long |>
  filter(stringr::str_detect(Method, "FSSUBSEG", negate=TRUE)) |>
  pivot_wider(names_from = Method, values_from = Volume) |>
  group_nest(Hemisphere, Structure) |>
  mutate(
    icc = map(
      data,
      ~select(.x, FIRST, FreeSurfer) |>
        irr::icc(model="twoway")),
    lower = map_dbl(icc, pluck, "lbound"),
    upper = map_dbl(icc, pluck, "ubound"),
    icc = map_dbl(icc, pluck, "value"),
    across(c(icc, lower, upper), \(x) round(x, 2)),
    icc = glue::glue("@@{lower}@{icc}@@{upper}@"),
    iccA = map(
      data,
      ~select(.x, FIRST, FreeSurfer) |>
        irr::icc(model="twoway",type = "agreement")),
    lower = map_dbl(iccA, pluck, "lbound"),
    upper = map_dbl(iccA, pluck, "ubound"),
    iccA = map_dbl(iccA, pluck, "value"),
    across(c(iccA, lower, upper), \(x) round(x, 2)),
    iccA = glue::glue("@@{lower}@{iccA}@@{upper}@"),
  ) |>
  select(Structure, Hemisphere, `ICC(C,1)`=icc, `ICC(A,1)`=iccA) |>
  arrange(Structure) |>
  gt::gt() |> 
  gt::text_transform(
    fn = subscript_formatting, 
    locations = gt::cells_body(columns=c("ICC(C,1)", "ICC(A,1)"))
  ) |>
  gt::as_latex()
```

```{r gen-other-vol-figs}
#| eval: false
figs <- purrr::map(
  c("Thalamus", "Putamen", "Accumbens", "Pallidum", "Caudate"), 
  plot_struct,
  volumes = select(ukb_vols, -ends_with("FSSUBSEG"))
) 
```

```{r}
#| label: fig-thalamus
#| fig-cap: "Thalamus Volume Comparison."
#| eval: false
figs[[1]]
```

```{r}
#| label: fig-putamen
#| fig-cap: "Putamen Volume Comparison."
#| eval: false
figs[[2]]
```

```{r}
#| label: fig-accumbens
#| fig-cap: "Accumbens Volume Comparison."
#| eval: false
figs[[3]]
```

```{r}
#| label: fig-pallidum
#| fig-cap: "Pallidum Volume Comparison."
#| eval: false
figs[[4]]
```

```{r}
#| label: fig-caudate
#| fig-cap: "Caudate Volume Comparison."
#| eval: false
figs[[5]]
```

## Intraclass Correlations After Residualizing on Potential Confounds {#sec-confounds}

One possible source of low intraclass correlations could be systematic inaccuracies with certain kinds of participants. For example, one of the two methods could tend to underestimate volumes when given brains that have experienced severe atrophy, which would decrease the agreement of the methods. To assess this, correlations between the amygdala volumes and the SIMPLE confounds within the UKB were calculated [@alfaro-almagro2021].

Several of the correlations appeared to be non-zero (@fig-partials-amyg). However, regressing these confounds from the estimated amygdala volumes did not improve the intraclass correlations (@tbl-iccs-deconfounded).

```{r}
#| label: fig-partials-amyg
#| fig-cap: 'Correlation Between Potential Confounders and Amygdala Volume Measurements. Summary describes how the the volumes were combined across methods. Summaries were either an average or a difference (FSL-FreeSurfer). Note that the variable "Head Size" corresponds to a scaling factor, and that larger values imply smaller brains.'
#| fig-height: 7

targets::tar_load(partials)
# a <- partials |> 
#   filter(Structure == "Amygdala") |>
  # mutate(term = forcats::fct_relabel(term, stringr::str_remove, " \\(imaging\\)")) |>
#   ggplot(aes(y=term, color=response)) + 
#   geom_errorbarh(aes(xmin=lower, xmax=upper)) + 
#   facet_wrap(~Hemisphere) +
#   xlab("Partial Correlation") +
#   theme_gray(base_size = 9) +
#   theme(legend.position = "bottom") 

partials |>
  dplyr::select(
    Variable=Parameter1, 
    Summary=Parameter2, 
    lower=CI_low, 
    upper=CI_high, 
    Hemisphere) |>
    mutate(Variable = forcats::fct_relabel(Variable, stringr::str_replace_all, "_" , ":")) |>
  ggplot(aes(y=Variable, color=Summary)) + 
  geom_errorbarh(aes(xmin=lower, xmax=upper)) + 
  facet_wrap(~Hemisphere, labeller = label_both) +
  xlab("Product-Moment Correlation with Summarized Amygdala Volumes") +
  theme_gray(base_size = 9) +
  theme(legend.position = "bottom") 

```


```{r}
#| label: tbl-iccs-deconfounded
#| tbl-cap: "Intraclass Correlation After Deconfounding. Prior to calculating consistency, volumes were deconfounded by a version of the SIMPLE parameter set described by @alfaro-almagro2021. For the list of variables, see @fig-partials-amyg. Subscripts indicate 95% confidence intervals."

ukb_vols |>
  mutate(acq_day = (acq_day - min(acq_day)) |> as.numeric()) |>
  na.omit() |>
  mutate(
    age2 = age^2,
    acq_day2 = acq_day^2,
    across(
      c(age, age2, t1_motion, head_size, acq_day, acq_day2), 
      \(x) (x - median(x)) / mad(x)),
    .by = site) |>
  pivot_longer(
    c(contains("Left"), contains("Right")),
    names_to = c("Structure", "Method"),
    names_pattern = "([[:print:]]+)_(FIRST|FreeSurfer)",
    values_to = "Volume") |>
  mutate(
    m = mean(Volume),
    Volume = resid(lm(Volume ~ site + (age*sex):site + age2:site + t1_motion:site + head_size:site + acq_day:site + acq_day2:site)),
    Volume = Volume + m,
    .by = c(Structure, Method)) |>
  select(-m) |>
  pivot_wider(names_from = Method, values_from = Volume) |>
  separate(Structure, c("Hemisphere", "Structure")) |>
  group_nest(Hemisphere, Structure) |>
  mutate(
    icc = map(
      data,
      ~select(.x, FIRST, FreeSurfer) |>
        irr::icc(model="twoway")),
    lower = map_dbl(icc, pluck, "lbound"),
    upper = map_dbl(icc, pluck, "ubound"),
    icc = map_dbl(icc, pluck, "value"),
    across(c(icc, lower, upper), \(x) round(x, 2)),
    icc = glue::glue("@@{lower}@{icc}@@{upper}@"),
    iccA = map(
      data,
      ~select(.x, FIRST, FreeSurfer) |>
        irr::icc(model="twoway",type = "agreement")),
    lower = map_dbl(iccA, pluck, "lbound"),
    upper = map_dbl(iccA, pluck, "ubound"),
    iccA = map_dbl(iccA, pluck, "value"),
    across(c(iccA, lower, upper), \(x) round(x, 2)),
    iccA = glue::glue("@@{lower}@{iccA}@@{upper}@"),
  ) |>
  select(Structure, Hemisphere, `ICC(C,1)`=icc, `ICC(A,1)`=iccA) |>
  arrange(Structure) |>
  gt::gt() |> 
  gt::text_transform(
    fn = subscript_formatting, 
    locations = gt::cells_body(columns=c("ICC(C,1)", "ICC(A,1)"))
  )|>
  gt::as_latex()

```

## Simulated Experiments {#sec-sim-details}

To simulate hypothetical data, the models described in the previous sections were used. Sample sizes were set between 10 to 100 in steps of 10. At each combination of parameters, experiments were repeated 1,000,000 times. Simulated experiments with the UKB data were performed analogously to those with hypothetical data.

Across repetitions, the rates of each effect were estimated by analytic Bayesian methods (binomial likelihood with Beta prior whose shape parameters were set to 1/2). The effect of "Different Significance" was calculated as the median of the posterior for which one correlation exhibited a $p$-value that was between 0.025 and 0.05 and the other was above 0.05, out of experiments in which at least one $p$-value was below 0.05. The effect of "Different Direction" was calculated as the median of the posterior, using experiments in which both correlations had opposite magnitudes given that both were significant. 

The 95% equal-tailed interval of the posteriors for the simulations are shown in @fig-left-right.

```{r}
#| label: fig-left-right
#| fig-cap: "Effects of Low Measurement Consistency on the UKB in Left and Right Hemispheres. Ribbons span 95% equal-tailed interval estimated from simulated experiments. See also Figure 2, where the medians are represented as color."
#| fig-height: 11
#| fig-width: 8

a <- make_spaghetti(cog_dif_sig, cog_dif_dir, "Left")
b <- make_spaghetti(cog_dif_sig, cog_dif_dir, "Right")

a + b + 
  plot_layout(guides = "collect", ncol = 1) + 
  plot_annotation(tag_levels = "a", tag_suffix = ")") &
  theme(legend.position = "bottom")

```


### Adjusting for ICV {#sec-adjust-icv}

When reporting differences in volume between groups, it is common to adjust for some measure of either head size or cerebral volume [@barnes_head_2010; @mathalon_correction_1993; @voevodskaya_effects_2014]. Adjusting by intracranial volume as estimated by FreeSurfer did not improve the intraclass correlations @tbl-adjust.

```{r}
#| label: tbl-adjust
#| tbl-cap: "Consistency of Volumes when Adjusting by Intracranial Volume. Adjustments were done by residualizing with respect to ICV. Subscripts indicate 95% confidence intervals."
#| fig-pos: 't'

ukb_vols_long |>
  filter(stringr::str_detect(Method, "FSSUBSEG", negate=TRUE)) |>
  pivot_wider(names_from = Method, values_from = Volume) |>
  mutate(
    across(
      c(ends_with("FreeSurfer"), ends_with("FIRST")), 
      \(x) mean(x) + resid(lm(x ~ icv)))) |>
  group_nest(Hemisphere, Structure) |>
  mutate(
    icc = map(
      data,
      ~select(.x, FIRST, FreeSurfer) |>
        irr::icc(model="twoway")),
    lower = map_dbl(icc, pluck, "lbound"),
    upper = map_dbl(icc, pluck, "ubound"),
    icc = map_dbl(icc, pluck, "value"),
    across(c(icc, lower, upper), \(x) round(x, 2)),
    icc = glue::glue("@@{lower}@{icc}@@{upper}@"),
    iccA = map(
      data,
      ~select(.x, FIRST, FreeSurfer) |>
        irr::icc(model="twoway",type = "agreement")),
    lower = map_dbl(iccA, pluck, "lbound"),
    upper = map_dbl(iccA, pluck, "ubound"),
    iccA = map_dbl(iccA, pluck, "value"),
    across(c(iccA, lower, upper), \(x) round(x, 2)),
    iccA = glue::glue("@@{lower}@{iccA}@@{upper}@"),
  ) |>
  select(Structure, Hemisphere, `ICC(C,1)`=icc, `ICC(A,1)`=iccA) |>
  arrange(Structure) |>
  gt::gt() |> 
  gt::text_transform(
    fn = subscript_formatting, 
    locations = gt::cells_body(columns=c("ICC(C,1)", "ICC(A,1)"))
  ) |>
  gt::as_latex()

```


## Measurement Error and Reduced Correlation Magnitude {#sec-measurement-error}

Using the model from @sec-icc-models, we can build a measurement noise model [e.g., @frost_correcting_2000]. Call the final target for which we hope to find a relationship with volume $y$. The relationship between that value and the volume was given by an ordinary linear regression with error $\delta$.

$$
\begin{aligned}
y_i & = \beta_0 + \beta_1\lambda_i + \delta_i \\
\delta_i & \sim N(0, \sigma_\delta^2) \\
\end{aligned}
$$

But since we do not know $\lambda$, the volumes estimated by the tools are used instead, changing the regression coefficient.

$$
y_i = \beta_0 + \tilde{\beta_1}x_i + \delta_i \\
$$

Dilution occurs because the coefficient $\tilde{\beta_1}$ estimated in this model tends to be closer zero, decreased by a factor related to the intraclass correlation [@frost_correcting_2000].

$$
\tilde{\beta_1} = \beta_1\frac{\sigma_\lambda^2}{\sigma_\lambda^2 + \sigma_\epsilon^2}
$$

Correspondingly, the desired correlation, $\rho=cor(y,\lambda)$, will also be biased.

$$
\begin{aligned}
\beta_1 & = \rho\frac{\sigma_\delta}{\sigma_\lambda} \\
\tilde{\beta_1} & = \tilde{\rho}\frac{\sigma_\delta}{sd(x)} \\ 
& =  \tilde{\rho} \frac{\sigma_\delta}{\sqrt{\sigma_\epsilon^2 + \sigma_\lambda^2}} \\
&  \implies \\
\rho \frac{\sigma_\delta}{\sigma_\lambda} &  = \tilde{\rho}\frac{\sigma_\delta}{\sqrt{\sigma_\epsilon^2+\sigma_\lambda^2}} \frac{\sigma_\lambda^2 + \sigma_\epsilon^2}{\sigma_\lambda^2} \\
&  \implies \\
\rho & = \tilde{\rho} \frac{\sqrt{\sigma_\epsilon^2+\sigma_\lambda^2}}{\sigma_\lambda }
\end{aligned}
$$

## Correlations Between Volumes of the Amygdala and Cognitive Variables

```{r}
#| label: fig-pop-cor
#| fig-cap: "Correlations Between Cognitive Factors and Estimated Volumes of the Left and Right Amygdala. Variables are ordered by decreasing rank correlation using average of left hemisphere volume estimates. Note that variables were selected based on the magnitude of their correlation with amygdalar volumes, which differed across hemispheres, and so the variables in left and right panels differ. Error bars span 95% confidence intervals (bootstrapped with 1000 samples)."
#| fig-height: 7

targets::tar_load(amyg_vols_cors)

amyg_vols_cors |> 
  summarise(
    lower=quantile(estimate, probs = 0.025), 
    upper=quantile(estimate, probs = 0.975), 
    .by = c(Method, predictor, Hemisphere)) |> 
  left_join(
    distinct(cog_dif_dir, rho=estimate, predictor, Hemisphere)) |> 
  mutate(
    predictor = interaction(predictor, round(abs(rho), digits=2)),
    predictor = ordered(predictor), 
    predictor = forcats::fct_relabel(predictor, ~stringr::str_extract(.x, "(?<=f.)([[:print:]]+)(?=.0.[[:digit:]]+$)")),
    Method = stringr::str_replace(Method, "FIRST", "FSL")) |> 
  ggplot(aes(y=predictor, color=Method)) + 
  facet_wrap(~Hemisphere, scales = "free_y", labeller = label_both) +
  geom_errorbarh(aes(xmin=lower, xmax=upper)) +
  ylab("Cognitive Variable") +
  xlab("Rank Correlation with\nAmygdala Volume") +
  theme_gray(base_size = 9) +
  theme(
    legend.position = "bottom"
  )

```


# References {.unnumbered}

::: {#refs}
:::
